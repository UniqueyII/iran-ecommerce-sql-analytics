-- Step 1: Create our professional database

-- Step 2: Create tables with REAL business constraints
CREATE TABLE customers (
    customer_id SERIAL PRIMARY KEY,
    national_code VARCHAR(10) UNIQUE,  -- Ú©Ø¯ Ù…Ù„ÛŒ
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    province VARCHAR(50) NOT NULL,
    city VARCHAR(50) NOT NULL,
    phone VARCHAR(11) UNIQUE,          -- Ø´Ù…Ø§Ø±Ù‡ Ù‡Ù…Ø±Ø§Ù‡
    email VARCHAR(100),
    registration_date DATE DEFAULT CURRENT_DATE,
    birth_date DATE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE categories (
    category_id SERIAL PRIMARY KEY,
    category_name VARCHAR(100) NOT NULL,
    parent_category_id INTEGER REFERENCES categories(category_id),
    description TEXT
);

CREATE TABLE products (
    product_id SERIAL PRIMARY KEY,
    product_name VARCHAR(200) NOT NULL,
    category_id INTEGER REFERENCES categories(category_id),
    brand VARCHAR(100),
    price DECIMAL(12, 2) NOT NULL CHECK (price > 0),
    cost_price DECIMAL(12, 2) NOT NULL,
    stock_quantity INTEGER DEFAULT 0 CHECK (stock_quantity >= 0),
    weight_kg DECIMAL(5, 2),
    is_active BOOLEAN DEFAULT TRUE,
    created_date DATE DEFAULT CURRENT_DATE,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    customer_id INTEGER REFERENCES customers(customer_id),
    order_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    total_amount DECIMAL(12, 2) NOT NULL CHECK (total_amount > 0),
    shipping_province VARCHAR(50) NOT NULL,
    shipping_city VARCHAR(50) NOT NULL,
    shipping_address TEXT NOT NULL,
    status VARCHAR(20) CHECK (status IN ('pending', 'confirmed', 'shipped', 'delivered', 'cancelled')),
    payment_method VARCHAR(30) CHECK (payment_method IN ('online', 'cash_on_delivery', 'bank_transfer')),
    payment_status VARCHAR(20) CHECK (payment_status IN ('pending', 'paid', 'failed', 'refunded')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE order_items (
    order_item_id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(order_id),
    product_id INTEGER REFERENCES products(product_id),
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(12, 2) NOT NULL CHECK (unit_price > 0),
    line_total DECIMAL(12, 2) GENERATED ALWAYS AS (quantity * unit_price) STORED
);

-- Step 3: Insert authentic Iranian data
INSERT INTO categories (category_name, parent_category_id, description) VALUES
('Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©', NULL, 'Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ'),
('Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ ØªØ¨Ù„Øª', 1, 'Ú¯ÙˆØ´ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ùˆ ØªØ¨Ù„Øª'),
('Ù„Ù¾ ØªØ§Ù¾ Ùˆ Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±', 1, 'Ù„Ù¾ ØªØ§Ù¾ Ùˆ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ú©Ø§Ù…Ù¾ÛŒÙˆØªØ±'),
('Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ', 1, 'Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ'),
('Ø®Ø§Ù†Ù‡ Ùˆ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡', NULL, 'Ù„ÙˆØ§Ø²Ù… Ø®Ø§Ù†Ù‡ Ùˆ Ø¢Ø´Ù¾Ø²Ø®Ø§Ù†Ù‡'),
('Ù…Ø¯ Ùˆ Ù¾ÙˆØ´Ø§Ú©', NULL, 'Ù„Ø¨Ø§Ø³ Ùˆ Ù¾ÙˆØ´Ø§Ú©');

-- Real Iranian customers
INSERT INTO customers (national_code, first_name, last_name, province, city, phone, email, birth_date) VALUES
('0123456769', 'Ø¹Ù„ÛŒ', 'Ù…Ø­Ù…Ø¯ÛŒ', 'ØªÙ‡Ø±Ø§Ù†', 'ØªÙ‡Ø±Ø§Ù†', '09121234667', 'ali.mohamadi@email.com', '1990-05-15'),
('1234567890', 'ÙØ§Ø·Ù…Ù‡', 'Ø§Ø­Ù…Ø¯ÛŒ', 'Ø§ØµÙÙ‡Ø§Ù†', 'Ø§ØµÙÙ‡Ø§Ù†', '09123456789', 'fateme.ahmadi@email.com', '1992-08-22'),
('2345678901', 'Ù…Ø­Ù…Ø¯', 'Ú©Ø±ÛŒÙ…ÛŒ', 'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ', 'Ù…Ø´Ù‡Ø¯', '09134567890', 'mohammad.karimi@email.com', '1988-12-10'),
('3456789012', 'Ø²Ù‡Ø±Ø§', 'Ø­Ø³ÛŒÙ†ÛŒ', 'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ', 'ØªØ¨Ø±ÛŒØ²', '09145678901', 'zahra.hosseini@email.com', '1995-03-30'),
('4567890123', 'Ø±Ø¶Ø§', 'Ø¬Ø¹ÙØ±ÛŒ', 'ÙØ§Ø±Ø³', 'Ø´ÛŒØ±Ø§Ø²', '09156789012', 'reza.jafari@email.com', '1993-07-18');

-- Real Iranian products with realistic prices (ØªÙˆÙ…Ø§Ù†)
INSERT INTO products (product_name, category_id, brand, price, cost_price, stock_quantity, weight_kg) VALUES
('Ú¯ÙˆØ´ÛŒ Ø³Ø§Ù…Ø³ÙˆÙ†Ú¯ Ú¯Ù„Ú©Ø³ÛŒ A52', 2, 'Samsung', 8500000, 7200000, 15, 0.189),
('Ú¯ÙˆØ´ÛŒ Ø´ÛŒØ§Ø¦ÙˆÙ…ÛŒ Ø±Ø¯Ù…ÛŒ Ù†ÙˆØª 11', 2, 'Xiaomi', 6500000, 5500000, 25, 0.195),
('Ù„Ù¾ ØªØ§Ù¾ Ù„Ù†ÙˆÙˆ Ø§ÛŒØ¯Ù‡ Ù¾Ø¯ 3', 3, 'Lenovo', 25000000, 21000000, 8, 1.7),
('Ù„Ù¾ ØªØ§Ù¾ Ø§ÛŒØ³ÙˆØ³ ÙˆÛŒÙˆÙˆØ¨ÙˆÚ©', 3, 'Asus', 32000000, 28000000, 5, 1.4),
('Ù‡Ø¯ÙÙˆÙ† Ø¨Ù„ÙˆØªÙˆØ« Ø³ÙˆÙ†ÛŒ WH-1000XM4', 4, 'Sony', 12000000, 9500000, 12, 0.254),
('Ù…Ø§ÙˆØ³ ÙˆØ§ÛŒØ±Ù„Ø³ Ù„Ø§Ø¬ÛŒØªÚ©', 4, 'Logitech', 450000, 350000, 30, 0.089),
('Ù¾Ø§ÙˆØ±Ø¨Ø§Ù†Ú© Ø´ÛŒØ§Ø¦ÙˆÙ…ÛŒ 20000 Ù…ÛŒÙ„ÛŒ Ø¢Ù…Ù¾Ø±', 4, 'Xiaomi', 800000, 600000, 40, 0.350),
('Ù‚Ù‡ÙˆÙ‡ Ø³Ø§Ø² ÙÙ„Ø±', 5, 'Philips', 3500000, 2800000, 18, 2.1),
('Ø¬Ø§Ø±ÙˆØ¨Ø±Ù‚ÛŒ Ø³Ø§Ù…Ø³ÙˆÙ†Ú¯', 5, 'Samsung', 4200000, 3500000, 10, 4.2);

-- order dates to have realistic historical data
SELECT order_id, customer_id, order_date, total_amount 
FROM orders 
ORDER BY order_date DESC;

-- If all dates are still current, let's fix them properly:
UPDATE orders SET order_date = '2023-12-01' WHERE order_id = 7;  -- 300+ days ago
UPDATE orders SET order_date = '2024-01-05' WHERE order_id = 10; -- 290+ days ago  
UPDATE orders SET order_date = '2024-02-14' WHERE order_id = 9;  -- 250+ days ago
UPDATE orders SET order_date = '2024-05-10' WHERE order_id = 8;  -- 160+ days ago
UPDATE orders SET order_date = '2024-06-01' WHERE order_id = 5;  -- 140+ days ago
UPDATE orders SET order_date = '2024-07-15' WHERE order_id = 1;  -- 100+ days ago
UPDATE orders SET order_date = '2024-08-20' WHERE order_id = 2;  -- 60+ days ago
UPDATE orders SET order_date = '2024-09-10' WHERE order_id = 3;  -- 45 days ago
UPDATE orders SET order_date = '2024-10-15' WHERE order_id = 4;  -- 10 days ago
UPDATE orders SET order_date = '2024-10-20' WHERE order_id = 6;  -- 5 days ago

SELECT order_id, customer_id, order_date, total_amount 
FROM orders 
ORDER BY order_id;

INSERT INTO orders (order_id, customer_id, order_date, total_amount, shipping_province, shipping_city, shipping_address, status, payment_method, payment_status) VALUES
(1, 1, '2023-12-01', 1500000, 'ØªÙ‡Ø±Ø§Ù†', 'ØªÙ‡Ø±Ø§Ù†', 'Ø®ÛŒØ§Ø¨Ø§Ù† ÙˆÙ„ÛŒØ¹ØµØ±ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³', 'delivered', 'online', 'paid'),
(2, 2, '2024-05-10', 8000000, 'Ø§ØµÙÙ‡Ø§Ù†', 'Ø§ØµÙÙ‡Ø§Ù†', 'Ú†Ù‡Ø§Ø±Ø¨Ø§Øº Ø¹Ø¨Ø§Ø³ÛŒØŒ Ú©ÙˆÚ†Ù‡ Û´Ûµ', 'delivered', 'cash_on_delivery', 'paid'),
(3, 4, '2025-02-14', 4500000, 'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ', 'ØªØ¨Ø±ÛŒØ²', 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø§Ù…Ø§Ù…ØŒ Ù¾Ù„Ø§Ú© Û³Û´', 'delivered', 'online', 'paid'),
(4, 5, '2025-08-05', 2000000, 'ÙØ§Ø±Ø³', 'Ø´ÛŒØ±Ø§Ø²', 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø²Ù†Ø¯ØŒ Ù¾Ù„Ø§Ú© ÛµÛ¶', 'delivered', 'bank_transfer', 'paid'),
(5, 1, '2024-07-15', 8500000, 'ØªÙ‡Ø±Ø§Ù†', 'ØªÙ‡Ø±Ø§Ù†', 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø§Ù†Ù‚Ù„Ø§Ø¨ØŒ Ù¾Ù„Ø§Ú© Û¸Û¹', 'delivered', 'online', 'paid'),
(6, 2, '2025-08-20', 12000000, 'Ø§ØµÙÙ‡Ø§Ù†', 'Ø§ØµÙÙ‡Ø§Ù†', 'Ú†Ù‡Ø§Ø±Ø¨Ø§Øº Ø¹Ø¨Ø§Ø³ÛŒØŒ Ú©ÙˆÚ†Ù‡ Û´Ûµ', 'shipped', 'cash_on_delivery', 'pending'),
(7, 3, '2025-09-10', 25000000, 'Ø®Ø±Ø§Ø³Ø§Ù† Ø±Ø¶ÙˆÛŒ', 'Ù…Ø´Ù‡Ø¯', 'Ø¨Ù„ÙˆØ§Ø± ÙˆÚ©ÛŒÙ„ Ø¢Ø¨Ø§Ø¯ØŒ Ù¾Ù„Ø§Ú© Û¶Û·', 'delivered', 'bank_transfer', 'paid'),
(8, 1, '2025-10-26', 450000, 'ØªÙ‡Ø±Ø§Ù†', 'ØªÙ‡Ø±Ø§Ù†', 'Ø®ÛŒØ§Ø¨Ø§Ù† ÙˆÙ„ÛŒØ¹ØµØ±ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³', 'confirmed', 'online', 'paid'),
(9, 4, '2024-06-01', 6500000, 'Ø¢Ø°Ø±Ø¨Ø§ÛŒØ¬Ø§Ù† Ø´Ø±Ù‚ÛŒ', 'ØªØ¨Ø±ÛŒØ²', 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø§Ù…Ø§Ù…ØŒ Ù¾Ù„Ø§Ú© Û³Û´', 'pending', 'cash_on_delivery', 'pending'),
(10, 5, '2025-10-20', 3500000, 'ÙØ§Ø±Ø³', 'Ø´ÛŒØ±Ø§Ø²', 'Ø®ÛŒØ§Ø¨Ø§Ù† Ø²Ù†Ø¯ØŒ Ù¾Ù„Ø§Ú© ÛµÛ¶', 'delivered', 'online', 'paid');


-- Add order items for the new orders
INSERT INTO order_items (order_id, product_id, quantity, unit_price) VALUES
(1, 7, 1, 1500000),   -- Power bank
(2, 4, 1, 8000000),   -- Asus laptop  
(3, 6, 2, 2250000),   -- 2 mice
(4, 8, 1, 2000000),   -- Coffee maker
(5, 1, 1, 8500000),   -- Samsung phone
(6, 5, 1, 12000000),  -- Sony headphones
(7, 3, 1, 25000000),  -- Lenovo laptop
(8, 6, 1, 450000),    -- Mouse
(9, 2, 1, 6500000),   -- Xiaomi phone
(10, 8, 1, 3500000);  -- Coffee maker

SELECT 
    order_id, 
    order_date, 
    (CURRENT_DATE - order_date::date) as days_ago,
    CASE 
        WHEN (CURRENT_DATE - order_date::date) > 120 THEN 'HIGH RISK'
        WHEN (CURRENT_DATE - order_date::date) BETWEEN 60 AND 120 THEN 'MEDIUM RISK'
        ELSE 'LOW RISK'
    END as risk_level
FROM orders 
ORDER BY days_ago DESC;

-- Delete all existing data
DELETE FROM order_items;
DELETE FROM orders;

-- 1. ØªØ­Ù„ÛŒÙ„ ÙØ±ÙˆØ´ Ø¨Ù‡ ØªÙÚ©ÛŒÚ© Ø§Ø³ØªØ§Ù†
SELECT 
    c.province as "Ø§Ø³ØªØ§Ù†",
    COUNT(DISTINCT o.customer_id) as "ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†",
    COUNT(o.order_id) as "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª",
    TO_CHAR(SUM(o.total_amount), '999,999,999') as "Ù…Ø¬Ù…ÙˆØ¹ ÙØ±ÙˆØ´ (ØªÙˆÙ…Ø§Ù†)",
    TO_CHAR(AVG(o.total_amount), '999,999,999') as "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯"
FROM customers c
JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.province
ORDER BY SUM(o.total_amount) DESC;

-- 2. Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ùˆ Ø§Ø±Ø²Ø´ Ø±ÛŒØ§Ù„ÛŒ Ø§Ù†Ø¨Ø§Ø±
SELECT 
    p.product_name as "Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„",
    p.brand as "Ø¨Ø±Ù†Ø¯",
    p.stock_quantity as "Ù…ÙˆØ¬ÙˆØ¯ÛŒ",
    TO_CHAR(p.price, '999,999,999') as "Ù‚ÛŒÙ…Øª ÙØ±ÙˆØ´",
    TO_CHAR(p.stock_quantity * p.cost_price, '999,999,999') as "Ø§Ø±Ø²Ø´ Ù…ÙˆØ¬ÙˆØ¯ÛŒ (ØªÙˆÙ…Ø§Ù†)",
    CASE 
        WHEN p.stock_quantity = 0 THEN 'ğŸŸ¥ Ø§ØªÙ…Ø§Ù… Ù…ÙˆØ¬ÙˆØ¯ÛŒ'
        WHEN p.stock_quantity < 5 THEN 'ğŸŸ¨ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù…'
        ELSE 'ğŸŸ© Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ø§ÙÛŒ'
    END as "ÙˆØ¶Ø¹ÛŒØª Ù…ÙˆØ¬ÙˆØ¯ÛŒ"
FROM products p
ORDER BY p.stock_quantity ASC;

-- 3. Ù…Ø´ØªØ±ÛŒØ§Ù† ÙˆÙØ§Ø¯Ø§Ø± (Ø¨Ø± Ø§Ø³Ø§Ø³ ØªØ¹Ø¯Ø§Ø¯ Ùˆ Ø§Ø±Ø²Ø´ Ø®Ø±ÛŒØ¯)
SELECT 
    c.first_name || ' ' || c.last_name as "Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ",
    c.province || ' - ' || c.city as "Ø´Ù‡Ø±Ø³ØªØ§Ù†",
    COUNT(o.order_id) as "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª",
    TO_CHAR(SUM(o.total_amount), '999,999,999') as "Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)",
    TO_CHAR(AVG(o.total_amount), '999,999,999') as "Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯",
    CASE 
        WHEN COUNT(o.order_id) >= 3 THEN 'Ù…Ø´ØªØ±ÛŒ Ø·Ù„Ø§ÛŒÛŒ'
        WHEN COUNT(o.order_id) = 2 THEN 'Ù…Ø´ØªØ±ÛŒ Ù†Ù‚Ø±Ù‡Ø§ÛŒ'
        ELSE 'Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯'
    END as "Ø³Ø·Ø­ ÙˆÙØ§Ø¯Ø§Ø±ÛŒ"
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name, c.province, c.city
HAVING COUNT(o.order_id) > 0
ORDER BY SUM(o.total_amount) DESC;

-- 4. Customer Lifetime Value Analysis
-- ØªØ­Ù„ÛŒÙ„  Ø±ÛŒØ³Ú© ØªØ±Ú© Ù…Ø´ØªØ±ÛŒØ§Ù†
SELECT 
    c.customer_id as "Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ",
    c.first_name || ' ' || c.last_name as "Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ",
    c.province as "Ø§Ø³ØªØ§Ù†", 
    c.city as "Ø´Ù‡Ø±",
    
    -- Ø¢Ù…Ø§Ø± Ø®Ø±ÛŒØ¯
    COUNT(o.order_id) as "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª",
    TO_CHAR(COALESCE(SUM(o.total_amount), 0), '999,999,999') as "Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÛŒØ¯",
    
    -- ØªØ­Ù„ÛŒÙ„ Ø²Ù…Ø§Ù†ÛŒ
    CASE 
        WHEN MAX(o.order_date) IS NULL THEN 'âŒ Ø¨Ø¯ÙˆÙ† Ø³Ø§Ø¨Ù‚Ù‡ Ø®Ø±ÛŒØ¯'
        ELSE TO_CHAR(MAX(o.order_date), 'YYYY-MM-DD')
    END as "ØªØ§Ø±ÛŒØ® Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯",
    
    -- Ø±ÙˆØ² Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯
    COALESCE((CURRENT_DATE - MAX(o.order_date)::date), 999) as "Ø±ÙˆØ² Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯",
    
    -- Ø³Ø·Ø­ Ø±ÛŒØ³Ú© ØªØ±Ú© (Ø¨Ø§ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ)
    CASE 
        WHEN MAX(o.order_date) IS NULL THEN 'ğŸ”´ Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ - Ø¨Ø¯ÙˆÙ† Ø®Ø±ÛŒØ¯'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) > 120 THEN 'ğŸ”´ Ø±ÛŒØ³Ú© Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 90 AND 120 THEN 'ğŸ”´ Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 60 AND 90 THEN 'ğŸŸ¡ Ø±ÛŒØ³Ú© Ù…ØªÙˆØ³Ø·'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 30 AND 60 THEN 'ğŸ”µ Ù†ÛŒØ§Ø² ØªÙˆØ¬Ù‡'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 7 AND 30 THEN 'ğŸŸ¢ ÙØ¹Ø§Ù„ Ø§Ø®ÛŒØ±'
        ELSE 'ğŸŸ¢ Ø¨Ø³ÛŒØ§Ø± ÙØ¹Ø§Ù„'
    END as "ÙˆØ¶Ø¹ÛŒØª Ù…Ø´ØªØ±ÛŒ",
    
    -- Ø§Ø±Ø²Ø´ Ù…Ø´ØªØ±ÛŒ
    CASE 
        WHEN COALESCE(SUM(o.total_amount), 0) > 20000000 THEN 'ğŸ’ Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§'
        WHEN COALESCE(SUM(o.total_amount), 0) > 10000000 THEN 'â­ Ø¨Ø§ Ø§Ø±Ø²Ø´ Ø¨Ø§Ù„Ø§' 
        WHEN COALESCE(SUM(o.total_amount), 0) > 5000000 THEN 'ğŸ“Š Ø§Ø±Ø²Ø´ Ù…ØªÙˆØ³Ø·'
        ELSE 'ğŸ“ˆ Ø§Ø±Ø²Ø´ Ù¾Ø§ÛŒÛŒÙ†'
    END as "Ø³Ø·Ø­ Ø§Ø±Ø²Ø´",
   
    -- Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… ÙØ±ÙˆØ´
    CASE 
        WHEN MAX(o.order_date) IS NULL THEN 'Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ®ÙÛŒÙ Û²Û°Ùª Ø¨Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ† Ø®Ø±ÛŒØ¯'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) > 120 THEN 'ØªÙ…Ø§Ø³ ÙÙˆØ±ÛŒ + Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÛµÛ°Ùª ØªØ®ÙÛŒÙ + Ù‡Ø¯ÛŒÙ‡'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 90 AND 120 THEN 'ØªÙ…Ø§Ø³ Ù…Ø³ØªÙ‚ÛŒÙ… + Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Û´Û°Ùª ØªØ®ÙÛŒÙ'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 60 AND 90 THEN 'Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø®ØµÛŒ + Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ Ø±Ø¶Ø§ÛŒØª'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 30 AND 60 THEN 'Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ + Ù†Ø¸Ø±Ø³Ù†Ø¬ÛŒ'
        ELSE 'Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙˆÙØ§Ø¯Ø§Ø±ÛŒ + Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯Ø§Øª ÙˆÛŒÚ˜Ù‡'
    END as "Ø§Ù‚Ø¯Ø§Ù… Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ"

FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name, c.province, c.city
ORDER BY 
    CASE 
        WHEN MAX(o.order_date) IS NULL THEN 1
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) > 120 THEN 2
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 90 AND 120 THEN 3
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 60 AND 90 THEN 4
        ELSE 5
    END,
    "Ø±ÙˆØ² Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯" DESC;

-- 5. Predictive Analytics: Customer Churn Risk
-- APPROACH 1: Single Query (Clean & Efficient)
SELECT 
    c.customer_id,
    c.first_name || ' ' || c.last_name as customer_name,
    c.province,
    (CURRENT_DATE - MAX(o.order_date)::date) as days_since_last_purchase,
    COUNT(o.order_id) as total_orders,
    SUM(o.total_amount) as total_spent,
    CASE 
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) > 90 THEN 'High Risk - Churned'
        WHEN (CURRENT_DATE - MAX(o.order_date)::date) BETWEEN 60 AND 90 THEN 'Medium Risk'
        ELSE 'Low Risk - Active'
    END as churn_risk
FROM customers c
LEFT JOIN orders o ON c.customer_id = o.customer_id
GROUP BY c.customer_id, c.first_name, c.last_name, c.province;

-- APPROACH 2: Subquery (More Readable for Complex Logic)
SELECT 
    customer_id,
    customer_name,
    province,
    (CURRENT_DATE - last_purchase_date) as days_since_last_purchase,
    total_orders,
    total_spent,
    CASE 
        WHEN (CURRENT_DATE - last_purchase_date) > 90 THEN 'High Risk - Churned'
        WHEN (CURRENT_DATE - last_purchase_date) BETWEEN 60 AND 90 THEN 'Medium Risk'
        ELSE 'Low Risk - Active'
    END as churn_risk
FROM (
    SELECT 
        c.customer_id, 
        c.first_name || ' ' || c.last_name as customer_name,
        c.province,
        MAX(o.order_date) as last_purchase_date,
        COUNT(o.order_id) as total_orders,
        SUM(o.total_amount) as total_spent
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.province
) customer_stats;

-- ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú© ØªØ±Ú© Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¨Ø§ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø± Ø§ÛŒØ±Ø§Ù†ÛŒ
SELECT 
    customer_id,
    first_name || ' ' || last_name as "Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ",
    province as "Ø§Ø³ØªØ§Ù†",
    city as "Ø´Ù‡Ø±",
    COALESCE((CURRENT_DATE - last_purchase_date::date), 999) as "Ø±ÙˆØ² Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø®Ø±ÛŒØ¯",
    COALESCE(order_count, 0) as "ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´Ø§Øª",
    COALESCE(TO_CHAR(total_spent, '999,999,999'), 'Û°') as "Ù…Ø¬Ù…ÙˆØ¹ Ø®Ø±ÛŒØ¯ (ØªÙˆÙ…Ø§Ù†)",
    CASE 
        WHEN last_purchase_date IS NULL THEN 'âŒ Ù‡Ø±Ú¯Ø² Ø®Ø±ÛŒØ¯ Ù†Ú©Ø±Ø¯Ù‡'
        WHEN (CURRENT_DATE - last_purchase_date::date) > 120 THEN 'ğŸ”´ Ø±ÛŒØ³Ú© Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§'
        WHEN (CURRENT_DATE - last_purchase_date::date) BETWEEN 90 AND 120 THEN 'ğŸŸ  Ø±ÛŒØ³Ú© Ø¨Ø§Ù„Ø§'
        WHEN (CURRENT_DATE - last_purchase_date::date) BETWEEN 60 AND 90 THEN 'ğŸŸ¡ Ù†ÛŒØ§Ø² ØªÙˆØ¬Ù‡'
        WHEN (CURRENT_DATE - last_purchase_date::date) BETWEEN 30 AND 60 THEN 'ğŸ”µ ÙØ¹Ø§Ù„ Ù…Ø¹Ù…ÙˆÙ„ÛŒ'
        ELSE 'ğŸŸ¢ Ø¨Ø³ÛŒØ§Ø± ÙØ¹Ø§Ù„'
    END as "ÙˆØ¶Ø¹ÛŒØª Ù…Ø´ØªØ±ÛŒ",
    
    -- ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¹Ù…Ù„ÛŒ Ø¨Ø±Ø§ÛŒ ØªÛŒÙ… ÙØ±ÙˆØ´
    CASE 
        WHEN last_purchase_date IS NULL THEN 'Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ ØªØ®ÙÛŒÙ Ø§ÙˆÙ„ÛŒÙ† Ø®Ø±ÛŒØ¯'
        WHEN (CURRENT_DATE - last_purchase_date::date) > 90 THEN 'ØªÙ…Ø§Ø³ Ù…Ø³ØªÙ‚ÛŒÙ… Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ ÙˆÛŒÚ˜Ù‡'
        WHEN (CURRENT_DATE - last_purchase_date::date) BETWEEN 60 AND 90 THEN 'Ø§ÛŒÙ…ÛŒÙ„ Ø´Ø®ØµÛŒâ€ŒØ³Ø§Ø²ÛŒ Ø´Ø¯Ù‡'
        ELSE 'Ø§Ø±Ø³Ø§Ù„ Ø®Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø¹Ù…ÙˆÙ„ÛŒ'
    END as "Ø§Ù‚Ø¯Ø§Ù… Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ"

FROM (
    SELECT 
        c.customer_id, c.first_name, c.last_name, c.province, c.city,
        MAX(o.order_date) as last_purchase_date,
        COUNT(o.order_id) as order_count,
        SUM(o.total_amount) as total_spent
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id, c.first_name, c.last_name, c.province, c.city
) customer_analysis
ORDER BY 
    CASE 
        WHEN last_purchase_date IS NULL THEN 1
        WHEN (CURRENT_DATE - last_purchase_date::date) > 90 THEN 2
        ELSE 3
    END,
    total_spent DESC NULLS LAST;

-- ØªØ­Ù„ÛŒÙ„ ÙØ±ØµØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù†
SELECT 
    'ÙØ±ØµØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø¯Ø±Ø¢Ù…Ø¯' as "ØªØ­Ù„ÛŒÙ„",
    TO_CHAR(SUM(total_spent) * 0.3, '999,999,999') as "Ø¯Ø±Ø¢Ù…Ø¯ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ (ØªÙˆÙ…Ø§Ù†)",
    'Ø¨Ø§ Û³Û°Ùª Ù†Ø±Ø® Ù…ÙˆÙÙ‚ÛŒØª' as "ÙØ±Ø¶ÛŒÙ‡",
    'Ø¨Ø±Ù†Ø§Ù…Ù‡ ØªÙ…Ø§Ø³ ÙÙˆØ±ÛŒ + ØªØ®ÙÛŒÙ ÙˆÛŒÚ˜Ù‡' as "Ø±Ø§Ù‡Ú©Ø§Ø±"
FROM (
    SELECT 
        c.customer_id,
        SUM(o.total_amount) as total_spent,
        MAX(o.order_date) as last_purchase_date
    FROM customers c
    JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id
    HAVING (CURRENT_DATE - MAX(o.order_date)::date) > 120  -- FIX: HAVING instead of WHERE
) high_risk_customers;

-- Ø®Ù„Ø§ØµÙ‡ Ø§Ø¬Ø±Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª
SELECT 
    'Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¯Ø± Ù…Ø¹Ø±Ø¶ ØªØ±Ú©' as "Ø¹Ù†ÙˆØ§Ù†",
    COUNT(*) as "ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´ØªØ±ÛŒØ§Ù†",
    TO_CHAR(SUM(total_spent), '999,999,999') as "Ø§Ø±Ø²Ø´ Ú©Ù„ Ø¯Ø± Ø®Ø·Ø±",
    'ÙÙˆØ±ÛŒ - Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ù‚Ø¯Ø§Ù… Ø³Ø±ÛŒØ¹' as "Ø§ÙˆÙ„ÙˆÛŒØª"
FROM (
    SELECT 
        c.customer_id,
        SUM(o.total_amount) as total_spent,
        MAX(o.order_date) as last_purchase_date
    FROM customers c
    JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id
    HAVING (CURRENT_DATE - MAX(o.order_date)::date) > 120  -- FIX: HAVING instead of WHERE
) high_risk_customers;


SELECT 
    'ØªØ­Ù„ÛŒÙ„ Ø±ÛŒØ³Ú© Ú©Ù„ÛŒ Ú©Ø³Ø¨â€ŒÙˆÚ©Ø§Ø±' as "Ø¨Ø®Ø´",
    COUNT(DISTINCT customer_id) as "Ú©Ù„ Ù…Ø´ØªØ±ÛŒØ§Ù†",  -- FIX: Removed "c."
    SUM(CASE WHEN days_since_last_purchase > 120 THEN 1 ELSE 0 END) as "Ù…Ø´ØªØ±ÛŒØ§Ù† Ù¾Ø±Ø±ÛŒØ³Ú©",
    ROUND(SUM(CASE WHEN days_since_last_purchase > 120 THEN 1 ELSE 0 END) * 100.0 / COUNT(DISTINCT customer_id), 1) as "Ø¯Ø±ØµØ¯ Ù…Ø´ØªØ±ÛŒØ§Ù† Ù¾Ø±Ø±ÛŒØ³Ú©",  -- FIX: Removed "c."
    TO_CHAR(SUM(total_spent), '999,999,999') as "Ú©Ù„ Ø¯Ø±Ø¢Ù…Ø¯ ØªØ§Ø±ÛŒØ®ÛŒ",
    TO_CHAR(SUM(CASE WHEN days_since_last_purchase > 120 THEN total_spent ELSE 0 END), '999,999,999') as "Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø± Ù…Ø¹Ø±Ø¶ Ø®Ø·Ø±",
    ROUND(SUM(CASE WHEN days_since_last_purchase > 120 THEN total_spent ELSE 0 END) * 100.0 / SUM(total_spent), 1) as "Ø¯Ø±ØµØ¯ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø± Ø®Ø·Ø±"
FROM (
    SELECT 
        c.customer_id,
        SUM(o.total_amount) as total_spent,
        (CURRENT_DATE - MAX(o.order_date)::date) as days_since_last_purchase
    FROM customers c
    LEFT JOIN orders o ON c.customer_id = o.customer_id
    GROUP BY c.customer_id
) customer_metrics;

